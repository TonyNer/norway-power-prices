<!-- public/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NO4 Electricity Prices</title>
  <style>
    :root { --pad: 16px; --max: 980px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: #0b0e13; color: #e9eef5; }
    header, main { max-width: var(--max); margin: auto; padding: var(--pad); }
    header { display: flex; align-items: baseline; gap: 12px; }
    h1 { font-size: 1.25rem; margin: 0; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: var(--pad); }
    .grid { display: grid; gap: var(--pad); grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid { grid-template-columns: 2fr 1fr; } }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#1f2937; }
    canvas { width: 100%; height: 340px; }
    a { color: #8ab4ff; }
    ul { list-style: none; padding-left: 0; margin: 0; }
    .threshold-form { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .threshold-form input { background: #0b0e13; border: 1px solid #374151; color: #e9eef5; border-radius: 6px; padding: 6px 10px; width: 120px; }
    .threshold-form button { background: #2563eb; border: none; color: #fff; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    .threshold-form button[disabled] { opacity: 0.6; cursor: default; }
    .threshold-hint { font-size: 0.85rem; opacity: 0.8; min-height: 1em; }
  </style>
</head>
<body>
<header>
  <h1>⚡ NO4 Electricity Prices</h1>
  <span id="status" class="pill">Loading…</span>
</header>

<main class="grid">
  <section class="card">
    <h2 style="margin-top:0">Next 12 Hours</h2>
    <canvas id="chart"></canvas>
    <div style="font-size:.9rem;opacity:.8;margin-top:10px">
      Telegram threshold: <strong id="threshold">—</strong> NOK/kWh
    </div>
    <form id="thresholdForm" class="threshold-form">
      <label for="thresholdInput" style="font-size:.9rem;">Update threshold</label>
      <input type="number" id="thresholdInput" step="0.01" min="0.01" required />
      <button type="submit">Save</button>
      <span id="thresholdMessage" class="threshold-hint"></span>
    </form>
  </section>
  <aside class="card">
    <div><strong>Next hour</strong> <div id="nextHour">—</div></div>
    <div style="margin-top:10px">
      <strong>Latest 24 entries</strong>
      <ul id="latest" style="max-height:180px; overflow:auto;"></ul>
    </div>
    <div style="margin-top:10px">
      <strong>Notifications</strong>
      <ul id="notifications" style="max-height:140px; overflow:auto; font-size:.9rem;"></ul>
    </div>
    <div style="opacity:.7;margin-top:10px">API: <a href="/api/forecast?hours=12">/api/forecast</a></div>
  </aside>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(async function(){
  const status = document.getElementById('status');
  const thresholdEl = document.getElementById('threshold');
  const thresholdInput = document.getElementById('thresholdInput');
  const thresholdForm = document.getElementById('thresholdForm');
  const thresholdMessage = document.getElementById('thresholdMessage');
  const nextHourEl = document.getElementById('nextHour');
  const latestEl = document.getElementById('latest');
  const notificationsEl = document.getElementById('notifications');
  let activeThreshold = 1.0;
  let priceChart = null;

  const escapeHtml = (str) =>
    String(str).replace(/[&<>"']/g, c => {
      switch (c) {
        case "&": return "&amp;";
        case "<": return "&lt;";
        case ">": return "&gt;";
        case '"': return "&quot;";
        case "'": return "&#39;";
        default: return c;
      }
    });

  function updateThresholdDisplay(value) {
    const formatted = value.toFixed(2);
    thresholdEl.textContent = formatted;
    if (thresholdInput) {
      thresholdInput.value = formatted;
    }
  }

  async function loadThreshold() {
    const res = await fetch('/api/threshold');
    if (!res.ok) throw new Error("Failed to load threshold");
    const data = await res.json();
    const val = Number(data?.value);
    if (Number.isFinite(val) && val > 0) {
      activeThreshold = val;
    }
    updateThresholdDisplay(activeThreshold);
  }

  async function refreshData() {
    const [forecastRes, latestRes, notificationsRes] = await Promise.all([
      fetch('/api/forecast?hours=12'),
      fetch('/api/prices?limit=24'),
      fetch('/api/notifications?limit=10')
    ]);
    const [forecast, latest, notifications] = await Promise.all([
      forecastRes.json(),
      latestRes.json(),
      notificationsRes.json()
    ]);

    if (forecast[0]) {
      const s = new Date(forecast[0].ts_start * 1000);
      const e = new Date(forecast[0].ts_end * 1000);
      nextHourEl.textContent = `${s.toLocaleString()} → ${e.toLocaleTimeString()} — ${forecast[0].price.toFixed(2)} NOK/kWh`;
    } else {
      nextHourEl.textContent = 'No upcoming data.';
    }

    latestEl.innerHTML = latest.map(r => {
      const d = new Date(r.ts_start * 1000);
      return `<li>${d.toLocaleString()} — <strong>${Number(r.price).toFixed(2)}</strong> NOK/kWh</li>`;
    }).join('');

    if (Array.isArray(notifications) && notifications.length) {
      notificationsEl.innerHTML = notifications
        .map(n => {
          const ts = new Date(n.created_at * 1000).toLocaleString();
          return `<li><strong>${ts}</strong><br>${escapeHtml(n.message)}</li>`;
        })
        .join('');
    } else {
      notificationsEl.innerHTML = "<li>No notifications logged yet.</li>";
    }

    const ctx = document.getElementById('chart');
    const labels = forecast.map(r =>
      new Date(r.ts_start * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    );
    const values = forecast.map(r => r.price);
    const lineColor = values.map(v =>
      v > activeThreshold ? 'rgba(239,68,68,0.9)' : 'rgba(59,130,246,0.9)'
    );

    if (priceChart) {
      priceChart.destroy();
    }
    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'NOK/kWh',
          data: values,
          borderColor: 'rgba(147,197,253,0.9)',
          backgroundColor: 'rgba(147,197,253,0.15)',
          tension: 0.25,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: lineColor
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true }, tooltip: { mode: 'index', intersect: false } },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'NOK/kWh' } },
          x: { title: { display: true, text: 'Hour' } }
        }
      }
    });

    status.textContent = 'Live';
  }

  function showThresholdMessage(text, isError = false) {
    if (!thresholdMessage) return;
    thresholdMessage.textContent = text;
    thresholdMessage.style.color = isError ? '#f87171' : '#9ca3af';
    if (text) {
      setTimeout(() => {
        thresholdMessage.textContent = "";
      }, 4000);
    }
  }

  thresholdForm?.addEventListener('submit', async e => {
    e.preventDefault();
    if (!thresholdInput) return;
    const next = Number(thresholdInput.value);
    if (!Number.isFinite(next) || next <= 0) {
      showThresholdMessage("Enter a positive number", true);
      return;
    }
    const button = thresholdForm.querySelector('button');
    button?.setAttribute('disabled', 'true');
    try {
      const res = await fetch('/api/threshold', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ value: next })
      });
      if (!res.ok) throw new Error("Failed to update threshold");
      const data = await res.json();
      const val = Number(data?.value);
      if (Number.isFinite(val) && val > 0) {
        activeThreshold = val;
      }
      updateThresholdDisplay(activeThreshold);
      showThresholdMessage("Threshold updated");
      await refreshData();
    } catch (err) {
      console.error(err);
      showThresholdMessage("Failed to update threshold", true);
    } finally {
      button?.removeAttribute('disabled');
    }
  });

  try {
    await loadThreshold();
    await refreshData();
  } catch (e) {
    console.error(e);
    status.textContent = 'Error';
  }
})();
</script>
</body>
</html>
