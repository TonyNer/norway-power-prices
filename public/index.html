<!-- public/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NO4 Electricity Prices</title>
  <style>
    :root { --pad: 16px; --max: 980px; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: #0b0e13; color: #e9eef5; }
    header, main { max-width: var(--max); margin: auto; padding: var(--pad); }
    header { display: flex; align-items: baseline; gap: 12px; }
    h1 { font-size: 1.25rem; margin: 0; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: var(--pad); }
    .grid { display: grid; gap: var(--pad); grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid { grid-template-columns: 2fr 1fr; } }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#1f2937; }
    canvas { width: 100%; height: 340px; }
    a { color: #8ab4ff; }
    ul { list-style: none; padding-left: 0; margin: 0; }
  </style>
</head>
<body>
<header>
  <h1>⚡ NO4 Electricity Prices</h1>
  <span id="status" class="pill">Loading…</span>
</header>

<main class="grid">
  <section class="card">
    <h2 style="margin-top:0">Next 12 Hours</h2>
    <canvas id="chart"></canvas>
    <div style="font-size:.9rem;opacity:.8">
      Threshold: <strong id="threshold">1.00</strong> NOK/kWh
    </div>
  </section>
  <aside class="card">
    <div><strong>Next hour</strong> <div id="nextHour">—</div></div>
    <div style="margin-top:10px">
      <strong>Latest 24 entries</strong>
      <ul id="latest" style="max-height:180px; overflow:auto;"></ul>
    </div>
    <div style="margin-top:10px">
      <strong>Notifications</strong>
      <ul id="notifications" style="max-height:140px; overflow:auto; font-size:.9rem;"></ul>
    </div>
    <div style="opacity:.7;margin-top:10px">API: <a href="/api/forecast?hours=12">/api/forecast</a></div>
  </aside>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(async function(){
  const status = document.getElementById('status');
  const thresholdEl = document.getElementById('threshold');
  const nextHourEl = document.getElementById('nextHour');
  const latestEl = document.getElementById('latest');
  const notificationsEl = document.getElementById('notifications');

  const urlT = new URL(location.href);
  const threshold = Number(urlT.searchParams.get("threshold") || "1.0") || 1.0;
  thresholdEl.textContent = threshold.toFixed(2);

  const escapeHtml = (str) =>
    String(str).replace(/[&<>"']/g, c => {
      switch (c) {
        case "&": return "&amp;";
        case "<": return "&lt;";
        case ">": return "&gt;";
        case '"': return "&quot;";
        case "'": return "&#39;";
        default: return c;
      }
    });

  try {
    const [forecastRes, latestRes, notificationsRes] = await Promise.all([
      fetch('/api/forecast?hours=12'),
      fetch('/api/prices?limit=24'),
      fetch('/api/notifications?limit=10')
    ]);
    const [forecast, latest, notifications] = await Promise.all([
      forecastRes.json(),
      latestRes.json(),
      notificationsRes.json()
    ]);

    if (forecast[0]) {
      const s = new Date(forecast[0].ts_start * 1000);
      const e = new Date(forecast[0].ts_end * 1000);
      nextHourEl.textContent = `${s.toLocaleString()} → ${e.toLocaleTimeString()} — ${forecast[0].price.toFixed(2)} NOK/kWh`;
    } else {
      nextHourEl.textContent = 'No upcoming data.';
    }

    latestEl.innerHTML = latest.map(r => {
      const d = new Date(r.ts_start * 1000);
      return `<li>${d.toLocaleString()} — <strong>${Number(r.price).toFixed(2)}</strong> NOK/kWh</li>`;
    }).join('');

    if (Array.isArray(notifications) && notifications.length) {
      notificationsEl.innerHTML = notifications
        .map(n => {
          const ts = new Date(n.created_at * 1000).toLocaleString();
          return `<li><strong>${ts}</strong><br>${escapeHtml(n.message)}</li>`;
        })
        .join('');
    } else {
      notificationsEl.innerHTML = "<li>No notifications logged yet.</li>";
    }

    const ctx = document.getElementById('chart');
    const labels = forecast.map(r => new Date(r.ts_start * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
    const values = forecast.map(r => r.price);
    const lineColor = values.map(v => v > threshold ? 'rgba(239,68,68,0.9)' : 'rgba(59,130,246,0.9)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'NOK/kWh',
          data: values,
          borderColor: 'rgba(147,197,253,0.9)',
          backgroundColor: 'rgba(147,197,253,0.15)',
          tension: 0.25,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: lineColor
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true }, tooltip: { mode: 'index', intersect: false } },
        scales: { y: { beginAtZero: true, title: { display: true, text: 'NOK/kWh' } }, x: { title: { display: true, text: 'Hour' } } }
      }
    });

    status.textContent = 'Live';
  } catch (e) {
    console.error(e);
    status.textContent = 'Error';
  }
})();
</script>
</body>
</html>
